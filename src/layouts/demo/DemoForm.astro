---
import { ChevronRight } from "@lucide/astro";
import SelectDropdown from "../../components/dropdowns/select-dropdown.astro";
---

<div>
  <form method="POST" id="contact-form" class="fade-in-scroll">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-x-6 gap-y-4">
      <div class="flex flex-col gap-4">
        <div>
          <label for="email" class="block text-color text-sm mb-1"
            >Work Email</label
          >
          <input
            name="email"
            id="email"
            type="email"
            class="w-full px-3 py-2 bg-card border border-input text-color rounded-md focus:outline-none focus:border-input"
          />
          <p class="text-xs text-color-primary hidden" data-error-for="email">
            Email is required.
          </p>
        </div>
        <div>
          <label for="name" class="block text-color text-sm mb-1"
            >Full Name</label
          >
          <input
            name="name"
            id="name"
            type="text"
            class="w-full px-3 py-2 bg-card border border-input text-color rounded-md focus:outline-none focus:border-input"
          />
          <p class="text-xs text-color-primary hidden" data-error-for="name">
            Name is required.
          </p>
        </div>
        <div>
          <label for="company" class="block text-color text-sm mb-1"
            >Company</label
          >
          <input
            name="company"
            id="company"
            type="text"
            class="w-full px-3 py-2 bg-card border border-input text-color rounded-md focus:outline-none focus:border-input"
          />
          <p class="text-xs text-color-primary hidden" data-error-for="company">
            Company is required.
          </p>
        </div>
        <div class="flex-1 flex flex-col">
          <label for="message" class="block text-color text-sm mb-1"
            >Message</label
          >
          <textarea
            name="message"
            id="message"
            rows="5"
            class="w-full flex-1 px-3 py-2 bg-card border border-input text-color rounded-md resize-none focus:outline-none focus:border-input"
          ></textarea>
        </div>
      </div>

      <div class="flex flex-col gap-4">
        <SelectDropdown
          id="company-size"
          name="company_size"
          label="Company Size"
          placeholder="Select company size"
          options={[
            { value: "1-10", label: "1-10" },
            { value: "11-50", label: "11-50" },
            { value: "51-200", label: "51-200" },
            { value: "201-1000", label: "201-1,000" },
            { value: "1000+", label: "1,000+" },
          ]}
        />
        <SelectDropdown
          id="primary-goal"
          name="primary_goal"
          label="Primary Goal"
          placeholder="Select primary goal"
          options={[
            { value: "soc2-readiness", label: "SOC 2 Readiness" },
            { value: "trust-center", label: "Trust Center" },
            { value: "replacing-tool", label: "Replacing Current Tool" },
            { value: "multi-framework-audit", label: "Multi-framework audit" },
            { value: "vendor-management", label: "Vendor Management" },
            {
              value: "automated-evidence",
              label: "Automated Evidence Collection",
            },
            { value: "just-exploring", label: "Just Exploring" },
          ]}
        />
        <SelectDropdown
          id="compliance-experience"
          name="compliance_experience"
          label="Current Compliance Experience"
          placeholder="Select experience level"
          options={[
            { value: "never-done", label: "I've never done this before" },
            {
              value: "starting-new",
              label: "I've done it before, but starting a new program",
            },
            { value: "in-progress", label: "In progress" },
            { value: "certified", label: "Certified (SOC 2 / ISO)" },
            { value: "multi-framework", label: "Multi-framework" },
          ]}
        />
        <SelectDropdown
          id="timeline"
          name="timeline"
          label="Timeline"
          placeholder="Select timeline"
          options={[
            { value: "asap", label: "ASAP" },
            { value: "1-3-months", label: "1-3 months" },
            { value: "3-6-months", label: "3-6 months" },
            { value: "just-researching", label: "Just researching" },
          ]}
        />
      </div>
    </div>

    <button
      id="submit-btn"
      type="submit"
      class="mt-6 text-sm font-semibold px-4 py-2 rounded-full bg-accent text-invert-primary inline-flex items-center gap-2 whitespace-nowrap cursor-pointer hover:bg-accent-300 transition-colors! duration-300!"
    >
      <span
        class="inline-flex items-center gap-2 whitespace-nowrap default-text"
      >
        Send <ChevronRight size={18} class="hidden lg:block" />
      </span>
      <span class="loading-text hidden">Sending...</span>
    </button>
  </form>
</div>

<script>
  import { actions } from "astro:actions";
  const siteKey = import.meta.env.PUBLIC_RECAPTCHA_SITE_KEY;

  document.addEventListener("astro:page-load", () => {
    const form = document.getElementById("contact-form");
    const button = document.getElementById("submit-btn");
    const loadingText = button.querySelector(".loading-text");
    const defaultText = button.querySelector(".default-text");
    const toastContainer = document.getElementById("toast-container");
    const toastIcons = {
      success: document.getElementById("toast-icon-success").innerHTML,
      error: document.getElementById("toast-icon-error").innerHTML,
    };

    function showToast(message, type = "success") {
      const toast = document.createElement("div");

      toast.className = `
        flex items-center gap-3 px-4 py-3 rounded-lg border shadow-lg w-full max-w-sm
        ${
          type === "success"
            ? "bg-card border-brand-400 text-color-primary"
            : "bg-[var(--destructive-background)] border-destructive !text-destructive-foreground"
        }
        animate-slide-in
      `;

      toast.innerHTML = `
        <div class="icon w-5 h-5 shrink-0">${toastIcons[type]}</div>
        <span class="flex-1 text-sm font-medium">${message}</span>
      `;
      toastContainer.appendChild(toast);
      setTimeout(() => {
        toast.classList.add("opacity-0", "translate-y-2");
        setTimeout(() => toast.remove(), 300);
      }, 5000);
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      let valid = true;

      ["name", "company", "email"].forEach((fieldName) => {
        const input = form.querySelector(`[name="${fieldName}"]`);
        const error = form.querySelector(`[data-error-for="${fieldName}"]`);
        if (!input.value.trim()) {
          error.classList.remove("hidden");
          valid = false;
        } else {
          error.classList.add("hidden");
        }
      });

      if (!valid) return;

      button.disabled = true;
      defaultText.classList.add("!hidden");
      loadingText.classList.remove("hidden");

      try {
        const recaptchaToken = await new Promise((resolve, reject) => {
          grecaptcha.ready(async () => {
            try {
              const token = await grecaptcha.execute(siteKey, {
                action: "submit",
              });
              resolve(token);
            } catch (err) {
              reject(new Error("recaptcha-generate-failed"));
            }
          });
        });

        const formData = new FormData(form);
        formData.append("recaptchaToken", recaptchaToken);
        const { data, error } = await actions.send(formData);

        if (error?.message === "recaptcha-failed") {
          showToast(
            "We couldn’t verify your request. Please try again.",
            "error",
          );
          return;
        }

        if (!data) {
          throw new Error("request-failed");
        }

        showToast("Message sent! We'll be in touch.", "success");
        form.reset();
      } catch (err) {
        console.error(err);
        if (err.message === "recaptcha-generate-failed") {
          showToast(
            "We couldn’t verify you're human. Please refresh and try again.",
            "error",
          );
        } else {
          showToast("Something went wrong. Please try again.", "error");
        }
      } finally {
        button.disabled = false;
        defaultText.classList.remove("!hidden");
        loadingText.classList.add("hidden");
      }
    });
  });
</script>
