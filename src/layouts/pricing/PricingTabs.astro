---
import { ChevronDown, ChevronUp } from "lucide-react";

type PricingPlan = {
  title: string;
  description: string;
  price: string;
  annualPrice: string;
  features: string[];
  comingSoon?: boolean;
};

type PricingData = {
  Modules: PricingPlan[];
  Addons: PricingPlan[];
};

const pricingData: PricingData = {
  Modules: [
    {
      title: "Compliance Module",
      description:
        "Build and run a structured, audit-ready compliance program without changing how your team works. Centralize policies, evidence, risk, vendors, and controls in one system designed to scale with your organization.",
      price: "$450",
      annualPrice: "$5,000",
      features: [
        "Unlimited Frameworks",
        "Program Creation",
        "Evidence Upload",
        "Policy and Procedures",
        "Vendor Management",
        "Risk Management",
        "Asset Management",
        "Personnel Management",
        "Questionnaire Automation",
        "Vulnerability Management",
        "Integrations",
        "Configurable Workflows and Notifications",
        "User and Group Level Permissions",
        "Unlimited Users",
        "Single Sign-On (SSO)",
        "Auditor Access",
        "1:1 Slack Support",
      ],
    },
    {
      title: "Trust Center",
      description:
        "Show prospects and customers exactly how you handle security and compliance. Share documentation behind NDA, customize your branding, and provide transparent subprocessor disclosures all in a professional Trust Center built to accelerate your sales process.",
      price: "$300",
      annualPrice: "$3,000",
      features: [
        "Unlimited Documents",
        "Subprocessor Management",
        "Clickwrap NDA",
        "Visitor Analytics",
        "Custom Domain and Branding",
        "Subprocessor Embedding",
      ],
    },
  ],
  Addons: [
    {
      title: "Additional Evidence Storage (100GB)",
      description:
        "Expand your secure storage capacity for compliance evidence. Keep your documentation organized and accessible.",
      price: "$10",
      annualPrice: "n/a",
      features: ["Secure Storage for Additional Evidence"],
    },
    {
      title: "Trust Center Attribution Removal",
      description:
        "Removes the \u201cPowered by Openlane\u201d footer from your Trust Center.",
      price: "$10",
      annualPrice: "$100",
      features: [
        "Remove Attribution from Trust Center",
        "Custom Footer Text",
        "Custom Footer Link",
      ],
      comingSoon: true,
    },
  ],
};
---

<div class="min-h-screen pt-10 pb-1">
  <div class="flex justify-center mb-10">
    <div class="flex bg-card rounded-full p-1 shadow-sm">
      <button
        data-billing="monthly"
        class="relative px-8 py-2 rounded-full font-semibold text-lg transition-all duration-150 bg-white shadow z-1"
      >
        Monthly
      </button>
      <button
        data-billing="yearly"
        class="relative px-8 py-2 rounded-full font-semibold text-lg transition-all duration-150 bg-transparent z-0"
      >
        Yearly
        <span
          class="ml-2 align-middle inline-block bg-white border border-border text-xs px-2 py-0.5 rounded-md shadow-sm font-medium"
        >
          7% OFF
        </span>
      </button>
    </div>
  </div>

  <div class="max-w-4xl mx-auto mb-12" data-section="modules">
    <div class="flex items-center mb-6">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="28"
        height="28"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
        class="text-brand w-7 h-7 mr-3"
      >
        <path
          d="M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z"
        ></path>
        <path d="m9 12 2 2 4-4"></path>
      </svg>
      <h3 class="text-5xl font-semibold text-gray-800">Select your modules</h3>
    </div>

    {
      pricingData.Modules.map((plan, idx) => (
        <div class="pricing-card rounded-2xl shadow p-10 mb-10 border border-border flex flex-col">
          <div class="flex justify-between items-start">
            <div class="flex items-start mr-4 pt-1">
              <button
                type="button"
                class={`indicator-btn text-gray-400 hover:text-gray-600 transition-colors${idx === 0 ? " hidden" : ""}`}
                data-title={plan.title}
                data-monthly={plan.price}
                data-yearly={plan.annualPrice}
                aria-label="Add to selection"
              >
                <!-- Unselected: CirclePlus -->
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  class="icon-plus w-6 h-6"
                >
                  <circle cx="12" cy="12" r="10" />
                  <path d="M12 8v8" />
                  <path d="M8 12h8" />
                </svg>
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  class="icon-check hidden w-6 h-6 text-brand"
                >
                  <circle cx="12" cy="12" r="10" />
                  <path d="m9 12 2 2 4-4" />
                </svg>
              </button>
              <input
                type="checkbox"
                class={`indicator-checkbox cursor-pointer w-5 h-5 mt-0.5 accent-brand${idx === 0 ? "" : " hidden"}`}
                data-title={plan.title}
                data-monthly={plan.price}
                data-yearly={plan.annualPrice}
              />
            </div>
            <div class="flex-1">
              <div class="flex items-center gap-3 mb-2">
                <p class="text-2xl font-semibold text-gray-800 mb-0">
                  {plan.title}
                </p>
                {plan.comingSoon && (
                  <span class="text-xs bg-brand px-2 py-1 rounded-full w-fit">
                    Coming Soon
                  </span>
                )}
              </div>
              <p class="text-lg text-gray-700 mb-4">{plan.description}</p>
            </div>
            <div class="flex flex-col items-end min-w-50 ml-6">
              <button
                class="mb-4 accordion-toggle"
                data-target={`module-features-${idx}`}
                aria-expanded={idx === 0 ? "true" : "false"}
              >
                <ChevronDown
                  size={28}
                  className={`chevron-down w-7 h-7${idx === 0 ? " hidden" : ""}`}
                />
                <ChevronUp
                  size={28}
                  className={`chevron-up w-7 h-7${idx === 0 ? "" : " hidden"}`}
                />
              </button>
              <span
                class="text-3xl font-semibold leading-none price-display"
                data-monthly={plan.price}
                data-yearly={plan.annualPrice}
              >
                {plan.price}
              </span>
              <span class="text-xl text-gray-400 font-semibold mb-2 period-display">
                /month
              </span>
            </div>
          </div>
          <div
            id={`module-features-${idx}`}
            class={idx === 0 ? "mt-6" : "hidden mt-6"}
          >
            <ul class="space-y-3">
              {plan.features.map((feature) => (
                <li class="flex items-center text-medium text-gray-800 font-medium">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="28"
                    height="28"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    class="text-brand w-7 h-7 mr-3"
                  >
                    <circle cx="12" cy="12" r="10" />
                    <path d="m9 12 2 2 4-4" />
                  </svg>
                  {feature}
                </li>
              ))}
            </ul>
          </div>
        </div>
      ))
    }
  </div>

  <div class="max-w-4xl mx-auto" data-section="addons">
    <div class="flex items-center mb-6">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="28"
        height="28"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
        class="text-brand w-7 h-7 mr-3"
      >
        <path
          d="M19.439 7.85c-.049.322.059.648.289.878l1.568 1.568c.47.47.706 1.087.706 1.704s-.235 1.233-.706 1.704l-1.611 1.611a.98.98 0 0 1-.837.276c-.47-.07-.802-.48-.968-.925a2.501 2.501 0 1 0-3.214 3.214c.446.166.855.497.925.968a.979.979 0 0 1-.276.837l-1.61 1.61a2.404 2.404 0 0 1-1.705.707 2.402 2.402 0 0 1-1.704-.706l-1.568-1.568a1.026 1.026 0 0 0-.877-.29c-.493.074-.84.504-1.02.968a2.5 2.5 0 1 1-3.237-3.237c.464-.18.894-.527.967-1.02a1.026 1.026 0 0 0-.289-.877l-1.568-1.568A2.402 2.402 0 0 1 1.998 12c0-.617.236-1.234.706-1.704L4.23 8.77c.24-.24.581-.353.917-.303.515.077.877.528 1.073 1.01a2.5 2.5 0 1 0 3.259-3.259c-.482-.196-.933-.558-1.01-1.073-.05-.336.062-.676.303-.917l1.525-1.525A2.402 2.402 0 0 1 12 2c.617 0 1.234.236 1.704.706l1.568 1.568c.23.23.556.338.877.29.493-.074.84-.504 1.02-.968a2.5 2.5 0 1 1 3.237 3.237c-.464.18-.894.527-.967 1.02z"
        ></path>
      </svg>
      <h3 class="font-semibold text-gray-800">Select your addons</h3>
    </div>

    {
      pricingData.Addons.map((plan, idx) => (
        <div class="pricing-card rounded-2xl shadow p-10 mb-10 border border-border flex flex-col">
          <div class="flex justify-between items-start">
            <div class="flex items-start mr-4 pt-1">
              <button
                type="button"
                class="indicator-btn text-gray-400 hover:text-gray-600 transition-colors"
                data-title={plan.title}
                data-monthly={plan.price}
                data-yearly={plan.annualPrice}
                aria-label="Add to selection"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  class="icon-plus w-6 h-6"
                >
                  <circle cx="12" cy="12" r="10" />
                  <path d="M12 8v8" />
                  <path d="M8 12h8" />
                </svg>
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  class="icon-check hidden w-6 h-6 text-brand"
                >
                  <circle cx="12" cy="12" r="10" />
                  <path d="m9 12 2 2 4-4" />
                </svg>
              </button>
              <input
                type="checkbox"
                class="indicator-checkbox hidden cursor-pointer w-5 h-5 mt-0.5 accent-brand"
                data-title={plan.title}
                data-monthly={plan.price}
                data-yearly={plan.annualPrice}
              />
            </div>
            <div class="flex-1">
              <div class="flex items-center gap-3 mb-2">
                <p class="text-2xl font-semibold text-gray-800 mb-0">
                  {plan.title}
                </p>
                {plan.comingSoon && (
                  <span class="text-xs bg-brand px-2 py-1 rounded-full w-fit">
                    Coming Soon
                  </span>
                )}
              </div>
              <p class="text-lg text-gray-700 mb-4">{plan.description}</p>
            </div>
            <div class="flex flex-col items-end min-w-50 ml-6">
              <button
                class="mb-4 accordion-toggle"
                data-target={`addon-features-${idx}`}
                aria-expanded="false"
              >
                <ChevronDown size={28} className="chevron-down w-7 h-7" />
                <ChevronUp size={28} className="chevron-up w-7 h-7 hidden" />
              </button>
              <span
                class="text-3xl font-semibold leading-none price-display"
                data-monthly={plan.price}
                data-yearly={plan.annualPrice}
              >
                {plan.price}
              </span>
              <span class="text-xl text-gray-400 font-semibold mb-2 period-display">
                /month
              </span>
            </div>
          </div>
          <div id={`addon-features-${idx}`} class="hidden mt-6">
            <ul class="space-y-3">
              {plan.features.map((feature) => (
                <li class="flex items-center text-medium text-gray-800 font-medium">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="28"
                    height="28"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    class="text-brand w-7 h-7 mr-3"
                  >
                    <circle cx="12" cy="12" r="10" />
                    <path d="m9 12 2 2 4-4" />
                  </svg>
                  {feature}
                </li>
              ))}
            </ul>
          </div>
        </div>
      ))
    }
  </div>

  <div
    id="pricing-summary"
    class="hidden max-w-4xl mx-auto mt-8 mb-4 p-8 rounded-2xl border border-border bg-card"
  >
    <h4 class="text-xl font-semibold text-gray-800 mb-4">Your Selection</h4>
    <ul id="selected-plans-list" class="divide-y divide-border mb-6"></ul>
    <div class="flex justify-between items-center pt-4 border-t border-border">
      <span class="text-lg font-semibold text-gray-800">Total</span>
      <div>
        <span id="pricing-total" class="text-3xl font-semibold">$0</span>
        <span
          id="pricing-total-period"
          class="text-xl text-gray-400 font-semibold ml-1">/month</span
        >
      </div>
    </div>
  </div>
</div>

<script>
  function initPricingTabs() {
    const firstBillingBtn =
      document.querySelector<HTMLButtonElement>("[data-billing]");
    if (!firstBillingBtn) return;
    if ((firstBillingBtn as any)._pricingInit) return;
    (firstBillingBtn as any)._pricingInit = true;

    let currentBilling: "monthly" | "yearly" = "monthly";
    const selected = new Map<
      string,
      { title: string; monthly: string; yearly: string }
    >();

    const billingButtons =
      document.querySelectorAll<HTMLButtonElement>("[data-billing]");
    const priceDisplays =
      document.querySelectorAll<HTMLElement>(".price-display");
    const periodDisplays =
      document.querySelectorAll<HTMLElement>(".period-display");

    billingButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        currentBilling = btn.dataset.billing as "monthly" | "yearly";

        billingButtons.forEach((b) => {
          const isActive = b.dataset.billing === currentBilling;
          b.classList.toggle("bg-white", isActive);
          b.classList.toggle("shadow", isActive);
          b.classList.toggle("bg-transparent", !isActive);
          b.style.zIndex = isActive ? "1" : "0";
        });

        priceDisplays.forEach((display) => {
          display.textContent =
            currentBilling === "monthly"
              ? (display.dataset.monthly ?? "")
              : (display.dataset.yearly ?? "");
        });

        periodDisplays.forEach((display) => {
          display.textContent =
            currentBilling === "monthly" ? "/month" : "/year";
        });

        updateSummary();
      });
    });

    function updateSummary() {
      const summaryDiv = document.getElementById("pricing-summary");
      const listEl = document.getElementById("selected-plans-list");
      const totalEl = document.getElementById("pricing-total");
      const periodEl = document.getElementById("pricing-total-period");
      if (!summaryDiv || !listEl || !totalEl || !periodEl) return;

      if (selected.size === 0) {
        summaryDiv.classList.add("hidden");
        return;
      }

      summaryDiv.classList.remove("hidden");

      let total = 0;
      const rows = Array.from(selected.values()).map((item) => {
        const priceStr =
          currentBilling === "monthly" ? item.monthly : item.yearly;
        const num = parseInt(priceStr.replace(/[$,]/g, ""), 10);
        if (!isNaN(num)) total += num;
        const suffix = currentBilling === "monthly" ? "/mo" : "/yr";
        return `<li class="flex justify-between items-center py-3 text-gray-700">
          <span class="font-medium">${item.title}</span>
          <span class="font-semibold">${priceStr !== "n/a" ? priceStr : "n/a"}<span class="text-gray-400 font-normal text-base"> ${suffix}</span></span>
        </li>`;
      });

      listEl.innerHTML = rows.join("");
      totalEl.textContent = `$${total.toLocaleString()}`;
      periodEl.textContent =
        currentBilling === "monthly" ? "/month" : "/year";
    }

    function selectCard(
      card: Element,
      title: string,
      monthly: string,
      yearly: string
    ) {
      selected.set(title, { title, monthly, yearly });
      card.querySelector(".icon-plus")?.classList.add("hidden");
      card.querySelector(".icon-check")?.classList.remove("hidden");
      const checkbox = card.querySelector<HTMLInputElement>(
        ".indicator-checkbox"
      );
      if (checkbox) checkbox.checked = true;
    }

    function deselectCard(card: Element, title: string) {
      selected.delete(title);
      card.querySelector(".icon-check")?.classList.add("hidden");
      card.querySelector(".icon-plus")?.classList.remove("hidden");
      const checkbox = card.querySelector<HTMLInputElement>(
        ".indicator-checkbox"
      );
      if (checkbox) checkbox.checked = false;
    }

    document
      .querySelectorAll<HTMLButtonElement>(".indicator-btn")
      .forEach((btn) => {
        btn.addEventListener("click", () => {
          const card = btn.closest(".pricing-card")!;
          const title = btn.dataset.title!;
          if (selected.has(title)) {
            deselectCard(card, title);
          } else {
            selectCard(card, title, btn.dataset.monthly!, btn.dataset.yearly!);
          }
          updateSummary();
        });
      });

    document
      .querySelectorAll<HTMLInputElement>(".indicator-checkbox")
      .forEach((checkbox) => {
        checkbox.addEventListener("change", () => {
          const card = checkbox.closest(".pricing-card")!;
          const title = checkbox.dataset.title!;
          if (checkbox.checked) {
            selectCard(
              card,
              title,
              checkbox.dataset.monthly!,
              checkbox.dataset.yearly!
            );
          } else {
            deselectCard(card, title);
          }
          updateSummary();
        });
      });

    function openCard(btn: HTMLButtonElement) {
      const card = btn.closest(".pricing-card")!;

      card.querySelector(".indicator-btn")?.classList.add("hidden");
      const checkbox =
        card.querySelector<HTMLInputElement>(".indicator-checkbox");
      if (checkbox) {
        checkbox.checked = selected.has(checkbox.dataset.title!);
        checkbox.classList.remove("hidden");
      }
      card.querySelector(".chevron-down")?.classList.add("hidden");
      card.querySelector(".chevron-up")?.classList.remove("hidden");

      document.getElementById(btn.dataset.target!)?.classList.remove("hidden");
      btn.setAttribute("aria-expanded", "true");
    }

    function closeCard(btn: HTMLButtonElement) {
      const card = btn.closest(".pricing-card")!;

      card.querySelector(".indicator-btn")?.classList.remove("hidden");
      card.querySelector(".indicator-checkbox")?.classList.add("hidden");

      card.querySelector(".chevron-up")?.classList.add("hidden");
      card.querySelector(".chevron-down")?.classList.remove("hidden");

      document.getElementById(btn.dataset.target!)?.classList.add("hidden");
      btn.setAttribute("aria-expanded", "false");
    }

    document
      .querySelectorAll<HTMLButtonElement>(".accordion-toggle")
      .forEach((btn) => {
        btn.addEventListener("click", () => {
          const sectionWrapper = btn.closest("[data-section]");
          if (!sectionWrapper) return;

          const isOpen = btn.getAttribute("aria-expanded") === "true";

          sectionWrapper
            .querySelectorAll<HTMLButtonElement>(".accordion-toggle")
            .forEach((sibling) => {
              if (
                sibling !== btn &&
                sibling.getAttribute("aria-expanded") === "true"
              ) {
                closeCard(sibling);
              }
            });

          if (isOpen) {
            closeCard(btn);
          } else {
            openCard(btn);
          }
        });
      });
  }

  document.addEventListener("DOMContentLoaded", initPricingTabs);
  document.addEventListener("astro:page-load", initPricingTabs);
</script>
