---
import BlogPost from "../../layouts/BlogPost.astro";

export async function getStaticPaths() {
  const res = await fetch(`${import.meta.env.PUBLIC_API_URL}/api/posts`);
  const posts = await res.json();

  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const baseUrl = "https://www.theopenlane.io";

const imageUrl = post.heroImage?.url
  ? `${import.meta.env.PUBLIC_API_URL}${post.heroImage.url}`
  : post.featuredImage && post.featuredImage.startsWith("http")
    ? post.featuredImage
    : `${baseUrl}/bolted-on.png`;

const schema = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  headline: post.title,
  description: post.excerpt || post.description,
  image: [imageUrl], // array is fine and recommended
  datePublished: post.publishedAt || post.createdAt,
  dateModified: post.updatedAt || post.publishedAt || post.createdAt,
  author: {
    "@type": "Person",
    name: post.author?.name || "Openlane Team",
    url: post.author?.url || baseUrl,
  },
  publisher: {
    "@type": "Organization",
    name: "Openlane",
    url: baseUrl,
  },
  mainEntityOfPage: {
    "@type": "WebPage",
    "@id": `${baseUrl}/blog/${post.slug}`,
  },
};
---

<BlogPost {...post} schema={schema} ogImage={imageUrl} />
