---
import BlogPost from "../../layouts/BlogPost.astro";

export async function getStaticPaths() {
  // Add depth parameter to populate author relationship
  const res = await fetch(
    `${import.meta.env.PUBLIC_API_URL}/api/posts?depth=2`,
  );
  const posts = await res.json();

  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const baseUrl = "https://www.theopenlane.io";

const imageUrl = post.heroImage?.url
  ? `${import.meta.env.PUBLIC_API_URL}${post.heroImage.url}`
  : post.featuredImage && post.featuredImage.startsWith("http")
    ? post.featuredImage
    : `${baseUrl}/bolted-on.png`;

// Debug: log the author to see what's coming through
console.log("Post author:", post.author);
console.log("Post authors:", post.authors);

// Handle both single author and authors array
const authorName =
  post.author?.name ||
  (post.authors && post.authors[0]?.name) ||
  "Openlane Team";

const authorUrl =
  post.author?.url || (post.authors && post.authors[0]?.url) || baseUrl;

const schema = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  headline: post.title,
  description: post.description || post.title,
  image: [imageUrl],
  datePublished: post.publishedAt || post.createdAt,
  dateModified: post.updatedAt || post.publishedAt || post.createdAt,
  author: {
    "@type": "Person",
    name: authorName,
    url: authorUrl,
  },
  publisher: {
    "@type": "Organization",
    name: "Openlane",
    url: baseUrl,
    logo: {
      "@type": "ImageObject",
      url: `${baseUrl}/logo/logo.png`,
    },
  },
  mainEntityOfPage: {
    "@type": "WebPage",
    "@id": `${baseUrl}/blog/${post.slug}`,
  },
};
---

<BlogPost {...post} schema={schema} ogImage={imageUrl} />
